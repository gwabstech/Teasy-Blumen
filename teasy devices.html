<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Teasy - Blumen POS</title>
    <style>
        :root {
            --primary: #0056b3;
            --primary-600: #004494;
            --bg: #f4f6f8;
            --card: #fff;
            --muted: #6b7280;
        }

        * {
            box-sizing: border-box
        }

        body {
            margin: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg);
            color: #111827;
            -webkit-font-smoothing: antialiased;
        }

        .wrap {
            max-width: 1100px;
            margin: 24px auto;
            padding: 16px
        }

        .container {
            background: var(--card);
            border-radius: 12px;
            box-shadow: 0 6px 30px rgba(2, 6, 23, 0.08);
            overflow: hidden;
        }

        .header {
            padding: 18px 20px;
            border-bottom: 1px solid #eef2f7;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px
        }

        .brand {
            display: flex;
            gap: 12px;
            align-items: center
        }

        .brand h1 {
            font-size: 1.125rem;
            margin: 0;
            color: var(--primary)
        }

        .controls {
            display: flex;
            gap: 8px;
            align-items: center
        }

        .main {
            display: flex;
            flex-wrap: wrap;
            padding: 18px
        }

        .panel {
            padding: 12px
        }

        /* left column - search/login */
        .left {
            flex: 1 1 320px;
            min-width: 260px
        }

        .right {
            flex: 1 1 420px;
            min-width: 260px
        }

        .card {
            background: #fff;
            padding: 14px;
            border-radius: 10px;
            border: 1px solid #f1f5f9
        }

        .search-row {
            display: flex;
            gap: 8px;
            margin-top: 8px
        }

        input[type="text"],
        input[type="password"],
        input[type="search"] {
            flex: 1;
            padding: 14px;
            border: 1px solid #e6eef8;
            border-radius: 10px;
            font-size: 16px
        }

        button {
            background: var(--primary);
            color: #fff;
            border: 0;
            padding: 12px 16px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 700
        }

        button.ghost {
            background: transparent;
            color: var(--primary);
            border: 1px solid #dbeafe
        }

        button.danger {
            background: #dc2626
        }

        .info {
            color: var(--muted);
            font-size: 13px;
            margin-top: 8px
        }

        .result-list {
            margin-top: 12px;
            display: grid;
            gap: 10px
        }

        .result-item {
            padding: 12px;
            border-radius: 8px;
            background: #f8fafc;
            border: 1px solid #e6f0ff
        }

        .result-item b {
            color: var(--primary)
        }

        .result-item .meta {
            display: flex;
            flex-direction: column;
            gap: 6px
        }

        .actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap
        }

        .top-actions {
            display: flex;
            gap: 8px
        }

        /* table for full view */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 12px
        }

        th,
        td {
            padding: 8px;
            border-bottom: 1px solid #f1f5f9;
            text-align: left;
            font-size: 14px
        }

        th {
            background: #fbfdff;
            color: var(--muted)
        }

        .table-wrap {
            overflow: auto;
            margin-top: 8px
        }

        .small {
            font-size: 13px;
            color: var(--muted)
        }

        @media (max-width:720px) {
            .main {
                flex-direction: column
            }

            .header {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px
            }

            .search-row {
                flex-direction: column
            }

            button {
                width: 100%
            }

            .top-actions {
                width: 100%;
                flex-direction: column
            }

            .wrap {
                padding: 12px;
                margin: 12px
            }

            .brand h1 {
                font-size: 1rem
            }

            input[type="text"],
            input[type="password"],
            input[type="search"] {
                font-size: 16px;
                padding: 14px
            }

            .result-item {
                padding: 14px
            }
        }
    </style>
</head>

<body>
    <div class="wrap">
        <div class="container">
            <div class="header">
                <div class="brand">
                    <svg width="36" height="36" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <rect width="24" height="24" rx="6" fill="#E8F3FF" />
                        <path d="M7 12h10" stroke="#0056B3" stroke-width="1.5" stroke-linecap="round"
                            stroke-linejoin="round" />
                        <path d="M7 8h10" stroke="#0056B3" stroke-width="1.5" stroke-linecap="round"
                            stroke-linejoin="round" />
                    </svg>
                    <h1>Teasy Blumen POS</h1>
                    <div class="small" style="margin-left:8px">Device lookup &amp; passcodes</div>
                </div>

                <div class="controls">
                    <div id="authStatus" class="small"></div>
                    <div id="authButtons" class="top-actions"></div>
                </div>
            </div>

            <div class="main">
                <div class="left panel">
                    <div class="card" id="loginCard">
                        <div style="display:flex;align-items:center;justify-content:space-between">
                            <div><strong>Access</strong></div>
                            <div class="small">You may search a single device without logging in</div>
                        </div>

                        <div id="loginForm" style="margin-top:10px">
                            <div style="display:flex;flex-direction:column;gap:8px">
                                <input id="searchInput" type="text"
                                    placeholder="Enter POS Serial (e.g., P260300035084)" />
                                <div class="search-row">
                                    <button id="searchBtn">Search</button>
                                    <button id="viewAllBtn" class="ghost" title="View all devices (login required)">View
                                        All</button>
                                </div>
                            </div>
                        </div>

                        <div id="loginBox" style="margin-top:12px;display:none">
                            <hr />
                            <div class="small">Login to view all devices and additional controls</div>
                            <div style="display:flex;flex-direction:column;gap:8px;margin-top:8px">
                                <input id="usernameInput" type="text" placeholder="Username" />
                                <input id="passwordInput" type="password" placeholder="Password" />
                                <div style="display:flex;gap:8px">
                                    <button id="loginBtn">Login</button>
                                    <button id="cancelLoginBtn" class="ghost">Cancel</button>
                                </div>
                            </div>
                        </div>

                        <div id="message" class="info" aria-live="polite"></div>
                    </div>
                </div>

                <div class="right panel">
                    <div class="card">
                        <div style="display:flex;align-items:center;justify-content:space-between">
                            <div><strong>Results</strong></div>
                            <div class="small">Search by serial to view passcode</div>
                        </div>

                        <div id="result" class="result-list"></div>

                        <div id="fullView" style="display:none">
                            <div class="table-wrap">
                                <table id="devicesTable">
                                    <thead>
                                        <tr>
                                            <th>Serial</th>
                                            <th>Agent</th>
                                            <th>Passcode</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // App state: token-based session stored in localStorage
        const STORAGE_KEY_TOKEN = 'teasy_token';

        function getToken() { return localStorage.getItem(STORAGE_KEY_TOKEN); }

        function setToken(t) { if (t) localStorage.setItem(STORAGE_KEY_TOKEN, t); else localStorage.removeItem(STORAGE_KEY_TOKEN); }

        // DOM
        const searchInput = document.getElementById('searchInput');
        const searchBtn = document.getElementById('searchBtn');
        const viewAllBtn = document.getElementById('viewAllBtn');
        const resultDiv = document.getElementById('result');
        const devicesTableBody = document.querySelector('#devicesTable tbody');
        const fullView = document.getElementById('fullView');
        const authStatus = document.getElementById('authStatus');
        const authButtons = document.getElementById('authButtons');
        const loginBox = document.getElementById('loginBox');
        const loginBtn = document.getElementById('loginBtn');
        const cancelLoginBtn = document.getElementById('cancelLoginBtn');
        const usernameInput = document.getElementById('usernameInput');
        const passwordInput = document.getElementById('passwordInput');
        const message = document.getElementById('message');

        function isLoggedIn() {
            return !!getToken();
        }

        function setLoggedIn(val) {
            // kept for compatibility; map to token storage
            if (val) setToken('1'); else setToken(null);
        }

        function formatCurrency(v) {
            const n = Number(v) || 0;
            return new Intl.NumberFormat('en-NG', { style: 'currency', currency: 'NGN' }).format(n);
        }

        function clearResults() { resultDiv.innerHTML = ''; devicesTableBody.innerHTML = ''; fullView.style.display = 'none'; }

        function renderAuth() {
            authButtons.innerHTML = '';
            if (isLoggedIn()) {
                authStatus.textContent = 'Signed in';
                const logoutBtn = document.createElement('button'); logoutBtn.textContent = 'Logout'; logoutBtn.className = 'ghost'; logoutBtn.onclick = logout;
                authButtons.appendChild(logoutBtn);
                viewAllBtn.disabled = false; viewAllBtn.classList.remove('ghost');
                loginBox.style.display = 'none';
            } else {
                authStatus.textContent = 'Not signed in';
                const showLogin = document.createElement('button'); showLogin.textContent = 'Login'; showLogin.onclick = () => { loginBox.style.display = 'block'; usernameInput.focus(); };
                showLogin.className = 'ghost';
                authButtons.appendChild(showLogin);
                viewAllBtn.disabled = false; // still clickable but will enforce auth
                loginBox.style.display = 'none';
            }
        }

        async function login() {
            const u = usernameInput.value.trim();
            const p = passwordInput.value;
            if (!u || !p) { message.textContent = 'Please enter username and password.'; return; }
            try {
                const res = await fetch('/api/login', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ username: u, password: p }) });
                if (!res.ok) { const err = await res.json().catch(() => ({ message: 'Login failed' })); message.textContent = err.message || 'Login failed'; return; }
                const data = await res.json();
                setToken(data.token);
                message.textContent = 'Login successful.';
                usernameInput.value = ''; passwordInput.value = '';
                renderAuth();
                renderFullList();
            } catch (err) { message.textContent = 'Login error: ' + err.message; }
        }

        function logout() { setToken(null); clearResults(); renderAuth(); message.textContent = 'Signed out.'; }

        async function searchPOS() {
            const input = searchInput.value.trim();
            clearResults();
            if (!input) { message.textContent = 'Please enter a Serial Number to search.'; return; }
            try {
                const res = await fetch('/api/devices?serial=' + encodeURIComponent(input));
                if (!res.ok) { message.textContent = 'Search failed'; return; }
                const found = await res.json();
                if (found.length) {
                    found.forEach(f => {
                        const el = document.createElement('div'); el.className = 'result-item';
                        el.innerHTML = `<div><b>${f['POS Serial']}</b></div>
                                        <div class='small'>Agent: ${f['Agent First Name']}</div>
                                        <div style='margin-top:8px;background:#fff;border-radius:6px;padding:8px;border:1px dashed #dbeafe'><div class='small'>Passcode</div><div style='font-weight:700;color:var(--primary)'>${f['Passcode']}</div></div>`;
                        resultDiv.appendChild(el);
                    });
                    message.textContent = '';
                } else {
                    message.textContent = 'No POS found with that Serial.';
                }
            } catch (err) { message.textContent = 'Search error: ' + err.message; }
        }

        async function renderFullList() {
            if (!isLoggedIn()) { message.textContent = 'You must login to view all devices.'; return; }
            devicesTableBody.innerHTML = '';
            try {
                const res = await fetch('/api/devices', { headers: { 'Authorization': 'Bearer ' + getToken() } });
                if (res.status === 401) { message.textContent = 'Session expired or not authorized.'; setToken(null); renderAuth(); return; }
                if (!res.ok) { message.textContent = 'Failed to load devices.'; return; }
                const data = await res.json();
                data.forEach(d => {
                    const tr = document.createElement('tr');
                    const serial = document.createElement('td'); serial.textContent = d['POS Serial'];
                    const agent = document.createElement('td'); agent.textContent = d['Agent First Name'];
                    const pass = document.createElement('td'); pass.textContent = d['Passcode'];
                    tr.appendChild(serial); tr.appendChild(agent); tr.appendChild(pass);
                    devicesTableBody.appendChild(tr);
                });
                fullView.style.display = 'block';
                message.textContent = '';
            } catch (err) { message.textContent = 'Error loading devices: ' + err.message; }
        }

        // Event wiring
        searchBtn.addEventListener('click', searchPOS);
        searchInput.addEventListener('keypress', function (e) { if (e.key === 'Enter') { searchPOS(); } });
        viewAllBtn.addEventListener('click', function () { if (isLoggedIn()) renderFullList(); else { message.textContent = 'Login required to view all devices.'; loginBox.style.display = 'block'; usernameInput.focus(); } });
        loginBtn.addEventListener('click', login);
        cancelLoginBtn.addEventListener('click', () => { loginBox.style.display = 'none'; message.textContent = ''; });
        passwordInput.addEventListener('keypress', function (e) { if (e.key === 'Enter') { login(); } });

        // Initialize UI
        renderAuth();

        // Expose small functions for debugging (optional)
        window.teasy = { login, logout, renderFullList };
    </script>
</body>

</html>